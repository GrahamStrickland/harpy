using Harpy.Lexer;
using Harpy.Parser;

namespace HarpyTests.ParserTests;

[TestClass]
public class TestParser
{
    [TestMethod]
    public void TestFunctionDefinition()
    {
        AssertParsedEqualsExpected(
            "function a()\n\n    local c := b\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "function a(b)\n\n    local c := b\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "function a(b, c, d)\n\n    local c := b\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    |
                    +---Token('c',1,[14:16))
                    |
                    +---Token('d',1,[17:19))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "function a(b)\n\n    local c := b\n\n    if b > 0\n        return 0\n    endif\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---OperatorExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',5,[7:9))
                                        )
                                    operator
                                    |
                                    +---Token('>',5,[9:11))
                                    right
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('0',5,[11:13))
                                        )
                                )
                            ifBody
                            |
                            +---ReturnStatement(
                                    returnValue
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('0',6,[15:17))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',9,[7:9))
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "function a(b)\n\n    local c := b\n\n    if b > 0\n        return .t.\n    endif\n\nreturn .f.",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---OperatorExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',5,[7:9))
                                        )
                                    operator
                                    |
                                    +---Token('>',5,[9:11))
                                    right
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('0',5,[11:13))
                                        )
                                )
                            ifBody
                            |
                            +---ReturnStatement(
                                    returnValue
                                    |
                                    +---LiteralExpression(
                                            literal(type=boolean)
                                            |
                                            +---Token('.t.',6,[15:19))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---LiteralExpression(
                            literal(type=boolean)
                            |
                            +---Token('.f.',9,[7:11))
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestProcedureDefinition()
    {
        AssertParsedEqualsExpected(
            "procedure a()\n\n    local c := b\n\nreturn",
            """
            SourceRoot(name='test')
            +---ProcedureStatement(
                    name
                    |
                    +---Token('a',1,[10:12))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "procedure a(b)\n\n    local c := b\n\nreturn",
            """
            SourceRoot(name='test')
            +---ProcedureStatement(
                    name
                    |
                    +---Token('a',1,[10:12))
                    parameters
                    |
                    +---Token('b',1,[12:14))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "procedure a(b, c, d)\n\n    local c := b\n\nreturn",
            """
            SourceRoot(name='test')
            +---ProcedureStatement(
                    name
                    |
                    +---Token('a',1,[10:12))
                    parameters
                    |
                    +---Token('b',1,[12:14))
                    |
                    +---Token('c',1,[15:17))
                    |
                    +---Token('d',1,[18:20))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "procedure a(b)\n\n    local c := b\n\n    if b > 0\n        return\n    endif\n\nreturn",
            """
            SourceRoot(name='test')
            +---ProcedureStatement(
                    name
                    |
                    +---Token('a',1,[10:12))
                    parameters
                    |
                    +---Token('b',1,[12:14))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---OperatorExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',5,[7:9))
                                        )
                                    operator
                                    |
                                    +---Token('>',5,[9:11))
                                    right
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('0',5,[11:13))
                                        )
                                )
                            ifBody
                            |
                            +---ReturnStatement()
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "procedure a(b)\n\n    local c := b\n\n    if b > 0\n        \n        d(b)\nreturn\n    endif\n\nreturn",
            """
            SourceRoot(name='test')
            +---ProcedureStatement(
                    name
                    |
                    +---Token('a',1,[10:12))
                    parameters
                    |
                    +---Token('b',1,[12:14))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---OperatorExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',5,[7:9))
                                        )
                                    operator
                                    |
                                    +---Token('>',5,[9:11))
                                    right
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('0',5,[11:13))
                                        )
                                )
                            ifBody
                            |
                            +---CallStatement(
                                    callExpression
                                    |
                                    +---CallExpression(
                                            function
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('d',7,[8:10))
                                                )
                                            arguments
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',7,[10:12))
                                                )
                                        )
                                )
                            |
                            +---ReturnStatement()
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestLocalDeclarationStatementIndexing()
    {
        AssertParsedEqualsExpected(
            "function a(b)\n\n    local c := b[1]\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---IndexExpression(
                                            left
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',3,[15:17))
                                                )
                                            index
                                            |
                                            +---LiteralExpression(
                                                    literal(type=number)
                                                    |
                                                    +---Token('1',3,[17:19))
                                                )
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "function a(b)\n\n    local c := b['key']\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---IndexExpression(
                                            left
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',3,[15:17))
                                                )
                                            index
                                            |
                                            +---LiteralExpression(
                                                    literal(type=string)
                                                    |
                                                    +---Token("'key'",3,[17:23))
                                                )
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
        // AssertParsedEqualsExpected(
        //     "function a(b)\n\n    local c := b[[key]]\n\nreturn c",
        //     "function a(b)\nlocal (c := b[[key]])\nreturn c"
        // );
        // AssertParsedEqualsExpected(
        //     "function a()\n\n    local b := [hello]\n\nreturn b",
        //     "function a()\nlocal (b := [hello])\nreturn b"
        // );
        AssertParsedEqualsExpected(
            "function a(b)\n\n    local c := b[1,2]\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    parameters
                    |
                    +---Token('b',1,[11:13))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---IndexExpression(
                                            left
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',3,[15:17))
                                                )
                                            index
                                            |
                                            +---LiteralExpression(
                                                    literal(type=number)
                                                    |
                                                    +---Token('1',3,[17:19))
                                                )
                                            |
                                            +---LiteralExpression(
                                                    literal(type=number)
                                                    |
                                                    +---Token('2',3,[19:21))
                                                )
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestStatics()
    {
        AssertParsedEqualsExpected(
            "static a := b",
            """
            SourceRoot(name='test')
            +---VariableDeclaration(
                    scope
                    |
                    +---Token('static',1,[1:7))
                    name
                    |
                    +---Token('a',1,[7:9))
                    assignment
                    |
                    +---AssignmentExpression(
                            left
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[7:9))
                                )
                            right
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[12:14))
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "static a := nil",
            """
            SourceRoot(name='test')
            +---VariableDeclaration(
                    scope
                    |
                    +---Token('static',1,[1:7))
                    name
                    |
                    +---Token('a',1,[7:9))
                    assignment
                    |
                    +---AssignmentExpression(
                            left
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[7:9))
                                )
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=nil)
                                    |
                                    +---Token('nil',1,[12:16))
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "static function a()\n\n    local c := b\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(static
                    name
                    |
                    +---Token('a',1,[16:18))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('local',3,[4:10))
                            name
                            |
                            +---Token('c',3,[10:12))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[10:12))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[15:17))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "function a()\n\n    static c := b\n\nreturn c",
            """
            SourceRoot(name='test')
            +---FunctionStatement(
                    name
                    |
                    +---Token('a',1,[9:11))
                    body
                    |
                    +---VariableDeclaration(
                            scope
                            |
                            +---Token('static',3,[4:11))
                            name
                            |
                            +---Token('c',3,[11:13))
                            assignment
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[11:13))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[16:18))
                                        )
                                )
                        )
                    returnValue
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('c',5,[7:9))
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestIfStatement()
    {
        AssertParsedEqualsExpected(
            "if a(b, c, d)\n\n    e()\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[3:5))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[5:7))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[11:13))
                                )
                        )
                    ifBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "if !a(b, c, d) .and. !e\n\n    f()\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---OperatorExpression(
                            left
                            |
                            +---PrefixExpression(
                                    operator
                                    |
                                    +---Token('!',1,[3:5))
                                    right
                                    |
                                    +---CallExpression(
                                            function
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('a',1,[4:6))
                                                )
                                            arguments
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',1,[6:8))
                                                )
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('c',1,[9:11))
                                                )
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('d',1,[12:14))
                                                )
                                        )
                                )
                            operator
                            |
                            +---Token('.and.',1,[15:21))
                            right
                            |
                            +---PrefixExpression(
                                    operator
                                    |
                                    +---Token('!',1,[21:23))
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',1,[22:24))
                                        )
                                )
                        )
                    ifBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('f',3,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "if a(b, c, d)\n\n    e()\n\nelse\n\n    f()\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[3:5))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[5:7))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[11:13))
                                )
                        )
                    ifBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                    elseBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('f',7,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "if a(b, c, d)\n\n    e()\n\nelseif f(b)\n\n    g()\n\n\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[3:5))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[5:7))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[11:13))
                                )
                        )
                    ifBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                    elseIfConditions
                        condition
                        |
                        +---CallExpression(
                                function
                                |
                                +---NameExpression(
                                        name
                                        |
                                        +---Token('f',5,[7:9))
                                    )
                                arguments
                                |
                                +---NameExpression(
                                        name
                                        |
                                        +---Token('b',5,[9:11))
                                    )
                            )
                        body
                        |
                        +---CallStatement(
                                callExpression
                                |
                                +---CallExpression(
                                        function
                                        |
                                        +---NameExpression(
                                                name
                                                |
                                                +---Token('g',7,[4:6))
                                            )
                                    )
                            )
                )

            """
        );
        AssertParsedEqualsExpected(
            "if a(b, /*@*/c, d)\n\n    e()\n\nelseif f(b)\n\n    g()\n\nelse\n\n    h()\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[3:5))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[5:7))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[13:15))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[16:18))
                                )
                        )
                    ifBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                    elseIfConditions
                        condition
                        |
                        +---CallExpression(
                                function
                                |
                                +---NameExpression(
                                        name
                                        |
                                        +---Token('f',5,[7:9))
                                    )
                                arguments
                                |
                                +---NameExpression(
                                        name
                                        |
                                        +---Token('b',5,[9:11))
                                    )
                            )
                        body
                        |
                        +---CallStatement(
                                callExpression
                                |
                                +---CallExpression(
                                        function
                                        |
                                        +---NameExpression(
                                                name
                                                |
                                                +---Token('g',7,[4:6))
                                            )
                                    )
                            )
                    elseBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('h',11,[4:6))
                                        )
                                )
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestWhileLoop()
    {
        AssertParsedEqualsExpected(
            "while a(b, c, d)\n\n    e()\n\nend",
            """
            SourceRoot(name='test')
            +---WhileLoopStatement(
                    condition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[6:8))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[11:13))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[14:16))
                                )
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "while a(b, c, d)\n\n    e()\n    f()\n\nend",
            """
            SourceRoot(name='test')
            +---WhileLoopStatement(
                    condition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[6:8))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[11:13))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[14:16))
                                )
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('f',4,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "while a(b, c, d)\n\n    e()\n    f()\n\nend while",
            """
            SourceRoot(name='test')
            +---WhileLoopStatement(
                    condition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[6:8))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[11:13))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[14:16))
                                )
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                )
                        )
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('f',4,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "  // Be careful with this\nwhile a(b, c, d)\n\n    e()\n    f()\n\nendwhile",
            """
            SourceRoot(name='test')
            +---WhileLoopStatement(
                    condition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',2,[6:8))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',2,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',2,[11:13))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',2,[14:16))
                                )
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',4,[4:6))
                                        )
                                )
                        )
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('f',5,[4:6))
                                        )
                                )
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestForLoop()
    {
        AssertParsedEqualsExpected(
            "for i := 1 to 10\n\n    a(i)\n\nnext",
            """
            SourceRoot(name='test')
            +---ForLoop(
                    initializer
                    |
                    +---AssignmentExpression(
                            left
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('i',1,[4:6))
                                )
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('1',1,[9:11))
                                )
                        )
                    bound
                    |
                    +---LiteralExpression(
                            literal(type=number)
                            |
                            +---Token('10',1,[14:17))
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[4:6))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('i',3,[6:8))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "for i := 10 to 1 step -1\n\n    a(i)\n\nnext",
            """
            SourceRoot(name='test')
            +---ForLoop(
                    initializer
                    |
                    +---AssignmentExpression(
                            left
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('i',1,[4:6))
                                )
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('10',1,[9:12))
                                )
                        )
                    bound
                    |
                    +---LiteralExpression(
                            literal(type=number)
                            |
                            +---Token('1',1,[15:17))
                        )
                    step
                    |
                    +---PrefixExpression(
                            operator
                            |
                            +---Token('-',1,[22:24))
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('1',1,[23:25))
                                )
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[4:6))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('i',3,[6:8))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "for each a in b\n\n    c(a)\n\nnext",
            """
            SourceRoot(name='test')
            +---ForEachLoopStatement(
                    variable
                    |
                    +---Token('a',1,[9:11))
                    collection
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('b',1,[14:16))
                        )
                    body
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[4:6))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[6:8))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "for i := 10 to 1 step -1\n\n    if c(i)\n\n\n\n        d(i)\n\n    else\n\n        loop\n\n    endif\n\nnext",
            """
            SourceRoot(name='test')
            +---ForLoop(
                    initializer
                    |
                    +---AssignmentExpression(
                            left
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('i',1,[4:6))
                                )
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('10',1,[9:12))
                                )
                        )
                    bound
                    |
                    +---LiteralExpression(
                            literal(type=number)
                            |
                            +---Token('1',1,[15:17))
                        )
                    step
                    |
                    +---PrefixExpression(
                            operator
                            |
                            +---Token('-',1,[22:24))
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('1',1,[23:25))
                                )
                        )
                    body
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[7:9))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('i',3,[9:11))
                                        )
                                )
                            ifBody
                            |
                            +---CallStatement(
                                    callExpression
                                    |
                                    +---CallExpression(
                                            function
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('d',7,[8:10))
                                                )
                                            arguments
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('i',7,[10:12))
                                                )
                                        )
                                )
                            elseBody
                            |
                            +---LoopStatement
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "for each a in b\n\n    if c(a)\n\n\n\n        d(a)\n\n    else\n\n        loop\n\n    endif\n\nnext",
            """
            SourceRoot(name='test')
            +---ForEachLoopStatement(
                    variable
                    |
                    +---Token('a',1,[9:11))
                    collection
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('b',1,[14:16))
                        )
                    body
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[7:9))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[9:11))
                                        )
                                )
                            ifBody
                            |
                            +---CallStatement(
                                    callExpression
                                    |
                                    +---CallExpression(
                                            function
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('d',7,[8:10))
                                                )
                                            arguments
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('a',7,[10:12))
                                                )
                                        )
                                )
                            elseBody
                            |
                            +---LoopStatement
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "for i := 10 to 1 step -1\n\n    if c(i)\n\n\n\n        d(i)\n\n    else\n\n        exit\n\n    endif\n\nnext",
            """
            SourceRoot(name='test')
            +---ForLoop(
                    initializer
                    |
                    +---AssignmentExpression(
                            left
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('i',1,[4:6))
                                )
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('10',1,[9:12))
                                )
                        )
                    bound
                    |
                    +---LiteralExpression(
                            literal(type=number)
                            |
                            +---Token('1',1,[15:17))
                        )
                    step
                    |
                    +---PrefixExpression(
                            operator
                            |
                            +---Token('-',1,[22:24))
                            right
                            |
                            +---LiteralExpression(
                                    literal(type=number)
                                    |
                                    +---Token('1',1,[23:25))
                                )
                        )
                    body
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[7:9))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('i',3,[9:11))
                                        )
                                )
                            ifBody
                            |
                            +---CallStatement(
                                    callExpression
                                    |
                                    +---CallExpression(
                                            function
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('d',7,[8:10))
                                                )
                                            arguments
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('i',7,[10:12))
                                                )
                                        )
                                )
                            elseBody
                            |
                            +---ExitStatement
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "for each a in b\n\n    if c(a)\n\n\n\n        d(a)\n\n    else\n\n        exit\n\n    endif\n\nnext",
            """
            SourceRoot(name='test')
            +---ForEachLoopStatement(
                    variable
                    |
                    +---Token('a',1,[9:11))
                    collection
                    |
                    +---NameExpression(
                            name
                            |
                            +---Token('b',1,[14:16))
                        )
                    body
                    |
                    +---IfStatement(
                            ifCondition
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',3,[7:9))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[9:11))
                                        )
                                )
                            ifBody
                            |
                            +---CallStatement(
                                    callExpression
                                    |
                                    +---CallExpression(
                                            function
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('d',7,[8:10))
                                                )
                                            arguments
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('a',7,[10:12))
                                                )
                                        )
                                )
                            elseBody
                            |
                            +---ExitStatement
                        )
                )

            """
              );
    }

    [TestMethod]
    public void TestBeginSequenceStatement()
    {
        AssertParsedEqualsExpected(
            "begin sequence\n\n    a()\n\nrecover\n\n    c()\n\nend sequence",
            """
            SourceRoot(name='test')
            +---BeginSequenceStatement(
                    beginSequenceBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[4:6))
                                        )
                                )
                        )
                    recoverBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',7,[4:6))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "begin sequence\n\n    a()\n\nrecover using b\n\n    c(b)\n\nend sequence",
            """
            SourceRoot(name='test')
            +---BeginSequenceStatement(
                    beginSequenceBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',3,[4:6))
                                        )
                                )
                        )
                    recoverBody
                        exception
                        |
                        +---Token('b',5,[14:16))
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',7,[4:6))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',7,[6:8))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "begin sequence with { |e| a(e) }\n\n    b()\n\nrecover using c\n\n    d(c)\n\nendsequence",
            """
            SourceRoot(name='test')
            +---BeginSequenceStatement(
                    errorHandler
                    |
                    +---CodeblockExpression(
                            parameters
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('e',1,[23:25))
                                )
                            expressions
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',1,[26:28))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',1,[28:30))
                                        )
                                )
                        )
                    beginSequenceBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[4:6))
                                        )
                                )
                        )
                    recoverBody
                        exception
                        |
                        +---Token('c',5,[14:16))
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('d',7,[4:6))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',7,[6:8))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "begin sequence with { |e| a(e) }\n\n    b()\n\nrecover using c\n\n    d(c)\n\nalways\n    e()\n\nend",
            """
            SourceRoot(name='test')
            +---BeginSequenceStatement(
                    errorHandler
                    |
                    +---CodeblockExpression(
                            parameters
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('e',1,[23:25))
                                )
                            expressions
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',1,[26:28))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',1,[28:30))
                                        )
                                )
                        )
                    beginSequenceBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',3,[4:6))
                                        )
                                )
                        )
                    recoverBody
                        exception
                        |
                        +---Token('c',5,[14:16))
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('d',7,[4:6))
                                        )
                                    arguments
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',7,[6:8))
                                        )
                                )
                        )
                    alwaysBody
                    |
                    +---CallStatement(
                            callExpression
                            |
                            +---CallExpression(
                                    function
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',10,[4:6))
                                        )
                                )
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestCallStatement()
    {
        AssertParsedEqualsExpected(
            "a:b(c)",
            """
            SourceRoot(name='test')
            +---CallStatement(
                    callExpression
                    |
                    +---CallExpression(
                            function
                            |
                            +---ObjectAccessExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('a',1,[1:2))
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('b',1,[2:4))
                                        )
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[4:6))
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "a:b:c(d)",
            """
            SourceRoot(name='test')
            +---CallStatement(
                    callExpression
                    |
                    +---CallExpression(
                            function
                            |
                            +---ObjectAccessExpression(
                                    left
                                    |
                                    +---ObjectAccessExpression(
                                            left
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('a',1,[1:2))
                                                )
                                            right
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',1,[2:4))
                                                )
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',1,[4:6))
                                        )
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[6:8))
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "a():b:c(d)",
            """
            SourceRoot(name='test')
            +---CallStatement(
                    callExpression
                    |
                    +---CallExpression(
                            function
                            |
                            +---ObjectAccessExpression(
                                    left
                                    |
                                    +---ObjectAccessExpression(
                                            left
                                            |
                                            +---CallExpression(
                                                    function
                                                    |
                                                    +---NameExpression(
                                                            name
                                                            |
                                                            +---Token('a',1,[1:2))
                                                        )
                                                )
                                            right
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('b',1,[4:6))
                                                )
                                        )
                                    right
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('c',1,[6:8))
                                        )
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[8:10))
                                )
                        )
                )

            """
        );
    }

    [TestMethod]
    public void TestAssignmentStatement()
    {
        AssertParsedEqualsExpected(
            "if a(b, c, d)\n\n    e := 1\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[3:5))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[5:7))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[11:13))
                                )
                        )
                    ifBody
                    |
                    +---AssignmentStatement(
                            assignmentExpression
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---NameExpression(
                                            name
                                            |
                                            +---Token('e',3,[4:6))
                                        )
                                    right
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('1',3,[9:11))
                                        )
                                )
                        )
                )

            """
        );
        AssertParsedEqualsExpected(
            "if a(b, c, d)\n\n    e:f := 1\n\nendif",
            """
            SourceRoot(name='test')
            +---IfStatement(
                    ifCondition
                    |
                    +---CallExpression(
                            function
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('a',1,[3:5))
                                )
                            arguments
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('b',1,[5:7))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('c',1,[8:10))
                                )
                            |
                            +---NameExpression(
                                    name
                                    |
                                    +---Token('d',1,[11:13))
                                )
                        )
                    ifBody
                    |
                    +---AssignmentStatement(
                            assignmentExpression
                            |
                            +---AssignmentExpression(
                                    left
                                    |
                                    +---ObjectAccessExpression(
                                            left
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('e',3,[4:6))
                                                )
                                            right
                                            |
                                            +---NameExpression(
                                                    name
                                                    |
                                                    +---Token('f',3,[6:8))
                                                )
                                        )
                                    right
                                    |
                                    +---LiteralExpression(
                                            literal(type=number)
                                            |
                                            +---Token('1',3,[11:13))
                                        )
                                )
                        )
                )

            """
        );
    }

    /// <summary>
    ///     Parses the given chunk of code and verifies that it matches the expected
    ///     pretty-printed result.
    /// </summary>
    private static void AssertParsedEqualsExpected(string source, string expected)
    {
        var lexer = new Lexer(source);
        var parser = new Parser(lexer);

        var root = parser.Parse("test");
        var actual = root.PrettyPrint();

        Assert.AreEqual(expected, actual);
    }
}
